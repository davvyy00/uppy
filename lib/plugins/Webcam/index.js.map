{"version":3,"sources":["../../../src/plugins/Webcam/index.js"],"names":["require","h","Plugin","Translator","getFileTypeExtension","canvasToBlob","supportsMediaRecorder","CameraIcon","CameraScreen","PermissionsScreen","getMediaDevices","navigator","mediaDevices","getUserMedia","mozGetUserMedia","webkitGetUserMedia","opts","resolve","reject","call","module","exports","uppy","supportsUserMedia","protocol","location","match","id","title","type","icon","defaultLocale","strings","smile","takePicture","startRecording","stopRecording","defaultOptions","onBeforeSnapshot","countdown","locale","modes","mirror","facingMode","translator","i18n","translate","bind","install","setPluginState","render","start","stop","takeSnapshot","oneTwoThreeSmile","focus","webcamActive","isSupported","getConstraints","acceptsAudio","indexOf","acceptsVideo","audio","video","Error","constraints","then","stream","cameraReady","catch","err","cameraError","recorder","MediaRecorder","recordingChunks","addEventListener","event","push","data","isRecording","stopped","getVideo","file","addFile","dashboard","getPlugin","hideAllPanels","error","getAudioTracks","forEach","track","getVideoTracks","getVideoElement","el","querySelector","count","countDown","setInterval","clearInterval","captureInProgress","info","setTimeout","message","getImage","tagFile","name","Date","now","mimeType","width","videoWidth","height","videoHeight","canvas","document","createElement","ctx","getContext","drawImage","blob","source","File","fileExtension","Blob","state","webcamState","getPluginState","target","mount","uninstall","unmount"],"mappings":"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","file":"index.js","sourcesContent":["const { h } = require('preact')\r\nconst Plugin = require('../../core/Plugin')\r\nconst Translator = require('../../core/Translator')\r\nconst getFileTypeExtension = require('../../utils/getFileTypeExtension')\r\nconst canvasToBlob = require('../../utils/canvasToBlob')\r\nconst supportsMediaRecorder = require('./supportsMediaRecorder')\r\nconst CameraIcon = require('./CameraIcon')\r\nconst CameraScreen = require('./CameraScreen')\r\nconst PermissionsScreen = require('./PermissionsScreen')\r\n\r\n// Setup getUserMedia, with polyfill for older browsers\r\n// Adapted from: https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia\r\nfunction getMediaDevices () {\r\n  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\r\n    return navigator.mediaDevices\r\n  }\r\n\r\n  const getUserMedia = navigator.mozGetUserMedia || navigator.webkitGetUserMedia\r\n  if (!getUserMedia) {\r\n    return null\r\n  }\r\n\r\n  return {\r\n    getUserMedia (opts) {\r\n      return new Promise((resolve, reject) => {\r\n        getUserMedia.call(navigator, opts, resolve, reject)\r\n      })\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Webcam\r\n */\r\nmodule.exports = class Webcam extends Plugin {\r\n  constructor (uppy, opts) {\r\n    super(uppy, opts)\r\n    this.mediaDevices = getMediaDevices()\r\n    this.supportsUserMedia = !!this.mediaDevices\r\n    this.protocol = location.protocol.match(/https/i) ? 'https' : 'http'\r\n    this.id = this.opts.id || 'Webcam'\r\n    this.title = 'Camera'\r\n    this.type = 'acquirer'\r\n    this.icon = CameraIcon\r\n\r\n    const defaultLocale = {\r\n      strings: {\r\n        smile: 'Smile!',\r\n        takePicture: 'Take a picture',\r\n        startRecording: 'Begin video recording',\r\n        stopRecording: 'Stop video recording'\r\n      }\r\n    }\r\n\r\n    // set default options\r\n    const defaultOptions = {\r\n      onBeforeSnapshot: () => Promise.resolve(),\r\n      countdown: false,\r\n      locale: defaultLocale,\r\n      modes: [\r\n        'video-audio',\r\n        'video-only',\r\n        'audio-only',\r\n        'picture'\r\n      ],\r\n      mirror: true,\r\n      facingMode: 'user'\r\n    }\r\n\r\n    // merge default options with the ones set by user\r\n    this.opts = Object.assign({}, defaultOptions, opts)\r\n\r\n    this.locale = Object.assign({}, defaultLocale, this.opts.locale)\r\n    this.locale.strings = Object.assign({}, defaultLocale.strings, this.opts.locale.strings)\r\n\r\n    // i18n\r\n    this.translator = new Translator({locale: this.locale})\r\n    this.i18n = this.translator.translate.bind(this.translator)\r\n\r\n    this.install = this.install.bind(this)\r\n    this.setPluginState = this.setPluginState.bind(this)\r\n\r\n    this.render = this.render.bind(this)\r\n\r\n    // Camera controls\r\n    this.start = this.start.bind(this)\r\n    this.stop = this.stop.bind(this)\r\n    this.takeSnapshot = this.takeSnapshot.bind(this)\r\n    this.startRecording = this.startRecording.bind(this)\r\n    this.stopRecording = this.stopRecording.bind(this)\r\n    this.oneTwoThreeSmile = this.oneTwoThreeSmile.bind(this)\r\n    this.focus = this.focus.bind(this)\r\n\r\n    this.webcamActive = false\r\n\r\n    if (this.opts.countdown) {\r\n      this.opts.onBeforeSnapshot = this.oneTwoThreeSmile\r\n    }\r\n  }\r\n\r\n  isSupported () {\r\n    return !!this.mediaDevices\r\n  }\r\n\r\n  getConstraints () {\r\n    const acceptsAudio = this.opts.modes.indexOf('video-audio') !== -1 ||\r\n      this.opts.modes.indexOf('audio-only') !== -1\r\n    const acceptsVideo = this.opts.modes.indexOf('video-audio') !== -1 ||\r\n      this.opts.modes.indexOf('video-only') !== -1 ||\r\n      this.opts.modes.indexOf('picture') !== -1\r\n\r\n    return {\r\n      audio: acceptsAudio,\r\n      video: acceptsVideo ? { facingMode: this.opts.facingMode } : false\r\n    }\r\n  }\r\n\r\n  start () {\r\n    if (!this.isSupported()) {\r\n      return Promise.reject(new Error('Webcam access not supported'))\r\n    }\r\n\r\n    this.webcamActive = true\r\n\r\n    const constraints = this.getConstraints()\r\n\r\n    // ask user for access to their camera\r\n    return this.mediaDevices.getUserMedia(constraints)\r\n      .then((stream) => {\r\n        this.stream = stream\r\n        // this.streamSrc = URL.createObjectURL(this.stream)\r\n        this.setPluginState({\r\n          cameraReady: true\r\n        })\r\n      })\r\n      .catch((err) => {\r\n        this.setPluginState({\r\n          cameraError: err\r\n        })\r\n      })\r\n  }\r\n\r\n  startRecording () {\r\n    // TODO We can check here if any of the mime types listed in the\r\n    // mimeToExtensions map in Utils.js are supported, and prefer to use one of\r\n    // those.\r\n    // Right now we let the browser pick a type that it deems appropriate.\r\n    this.recorder = new MediaRecorder(this.stream)\r\n    this.recordingChunks = []\r\n    this.recorder.addEventListener('dataavailable', (event) => {\r\n      this.recordingChunks.push(event.data)\r\n    })\r\n    this.recorder.start()\r\n\r\n    this.setPluginState({\r\n      isRecording: true\r\n    })\r\n  }\r\n\r\n  stopRecording () {\r\n    const stopped = new Promise((resolve, reject) => {\r\n      this.recorder.addEventListener('stop', () => {\r\n        resolve()\r\n      })\r\n      this.recorder.stop()\r\n    })\r\n\r\n    return stopped.then(() => {\r\n      this.setPluginState({\r\n        isRecording: false\r\n      })\r\n      return this.getVideo()\r\n    })\r\n    .then((file) => {\r\n      try {\r\n        this.uppy.addFile(file)\r\n      } catch (err) {\r\n        // Nothing, restriction errors handled in Core\r\n      }\r\n    })\r\n    .then(() => {\r\n      this.recordingChunks = null\r\n      this.recorder = null\r\n      const dashboard = this.uppy.getPlugin('Dashboard')\r\n      if (dashboard) dashboard.hideAllPanels()\r\n    }, (error) => {\r\n      this.recordingChunks = null\r\n      this.recorder = null\r\n      throw error\r\n    })\r\n  }\r\n\r\n  stop () {\r\n    this.stream.getAudioTracks().forEach((track) => {\r\n      track.stop()\r\n    })\r\n    this.stream.getVideoTracks().forEach((track) => {\r\n      track.stop()\r\n    })\r\n    this.webcamActive = false\r\n    this.stream = null\r\n  }\r\n\r\n  getVideoElement () {\r\n    return this.el.querySelector('.uppy-Webcam-video')\r\n  }\r\n\r\n  oneTwoThreeSmile () {\r\n    return new Promise((resolve, reject) => {\r\n      let count = this.opts.countdown\r\n\r\n      let countDown = setInterval(() => {\r\n        if (!this.webcamActive) {\r\n          clearInterval(countDown)\r\n          this.captureInProgress = false\r\n          return reject(new Error('Webcam is not active'))\r\n        }\r\n\r\n        if (count > 0) {\r\n          this.uppy.info(`${count}...`, 'warning', 800)\r\n          count--\r\n        } else {\r\n          clearInterval(countDown)\r\n          this.uppy.info(this.i18n('smile'), 'success', 1500)\r\n          setTimeout(() => resolve(), 1500)\r\n        }\r\n      }, 1000)\r\n    })\r\n  }\r\n\r\n  takeSnapshot () {\r\n    if (this.captureInProgress) return\r\n    this.captureInProgress = true\r\n\r\n    this.opts.onBeforeSnapshot().catch((err) => {\r\n      const message = typeof err === 'object' ? err.message : err\r\n      this.uppy.info(message, 'error', 5000)\r\n      return Promise.reject(new Error(`onBeforeSnapshot: ${message}`))\r\n    }).then(() => {\r\n      return this.getImage()\r\n    }).then((tagFile) => {\r\n      this.captureInProgress = false\r\n      const dashboard = this.uppy.getPlugin('Dashboard')\r\n      if (dashboard) dashboard.hideAllPanels()\r\n      try {\r\n        this.uppy.addFile(tagFile)\r\n      } catch (err) {\r\n        // Nothing, restriction errors handled in Core\r\n      }\r\n    }, (error) => {\r\n      this.captureInProgress = false\r\n      throw error\r\n    })\r\n  }\r\n\r\n  getImage () {\r\n    const video = this.getVideoElement()\r\n    if (!video) {\r\n      return Promise.reject(new Error('No video element found, likely due to the Webcam tab being closed.'))\r\n    }\r\n\r\n    const name = `webcam-${Date.now()}.jpg`\r\n    const mimeType = 'image/jpeg'\r\n\r\n    const width = video.videoWidth\r\n    const height = video.videoHeight\r\n\r\n    // const scaleH = this.opts.mirror ? -1 : 1 // Set horizontal scale to -1 if flip horizontal\r\n    // const scaleV = 1\r\n    // const posX = this.opts.mirror ? width * -1 : 0 // Set x position to -100% if flip horizontal\r\n    // const posY = 0\r\n\r\n    const canvas = document.createElement('canvas')\r\n    canvas.width = width\r\n    canvas.height = height\r\n    const ctx = canvas.getContext('2d')\r\n    ctx.drawImage(video, 0, 0)\r\n    // ctx.save() // Save the current state\r\n    // ctx.scale(scaleH, scaleV) // Set scale to flip the image\r\n    // ctx.drawImage(video, posX, posY, width, height) // draw the image\r\n    // ctx.restore() // Restore the last saved state\r\n\r\n    return canvasToBlob(canvas, mimeType).then((blob) => {\r\n      return {\r\n        source: this.id,\r\n        name: name,\r\n        data: new File([blob], name, { type: mimeType }),\r\n        type: mimeType\r\n      }\r\n    })\r\n  }\r\n\r\n  getVideo () {\r\n    const mimeType = this.recordingChunks[0].type\r\n    const fileExtension = getFileTypeExtension(mimeType)\r\n\r\n    if (!fileExtension) {\r\n      return Promise.reject(new Error(`Could not retrieve recording: Unsupported media type \"${mimeType}\"`))\r\n    }\r\n\r\n    const name = `webcam-${Date.now()}.${fileExtension}`\r\n    const blob = new Blob(this.recordingChunks, { type: mimeType })\r\n    const file = {\r\n      source: this.id,\r\n      name: name,\r\n      data: new File([blob], name, { type: mimeType }),\r\n      type: mimeType\r\n    }\r\n\r\n    return Promise.resolve(file)\r\n  }\r\n\r\n  focus () {\r\n    if (this.opts.countdown) return\r\n    setTimeout(() => {\r\n      this.uppy.info(this.i18n('smile'), 'success', 1500)\r\n    }, 1000)\r\n  }\r\n\r\n  render (state) {\r\n    if (!this.webcamActive) {\r\n      this.start()\r\n    }\r\n\r\n    const webcamState = this.getPluginState()\r\n\r\n    if (!webcamState.cameraReady) {\r\n      return <PermissionsScreen icon={CameraIcon} />\r\n    }\r\n\r\n    return <CameraScreen\r\n      {...webcamState}\r\n      onSnapshot={this.takeSnapshot}\r\n      onStartRecording={this.startRecording}\r\n      onStopRecording={this.stopRecording}\r\n      onFocus={this.focus}\r\n      onStop={this.stop}\r\n      i18n={this.i18n}\r\n      modes={this.opts.modes}\r\n      supportsRecording={supportsMediaRecorder()}\r\n      recording={webcamState.isRecording}\r\n      mirror={this.opts.mirror}\r\n      src={this.stream} />\r\n  }\r\n\r\n  install () {\r\n    this.setPluginState({\r\n      cameraReady: false\r\n    })\r\n\r\n    const target = this.opts.target\r\n    if (target) {\r\n      this.mount(target, this)\r\n    }\r\n  }\r\n\r\n  uninstall () {\r\n    if (this.stream) {\r\n      this.stop()\r\n    }\r\n\r\n    this.unmount()\r\n  }\r\n}\r\n"]}