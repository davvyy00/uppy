{"version":3,"sources":["../../../src/plugins/Transloadit/index.js"],"names":["Translator","require","Plugin","Tus","Client","StatusSocket","defaultGetAssemblyOptions","file","options","params","signature","fields","UPPY_SERVER","TL_UPPY_SERVER","module","exports","uppy","opts","type","id","title","defaultLocale","strings","creatingAssembly","creatingAssemblyFailed","encoding","defaultOptions","service","waitForEncoding","waitForMetadata","alwaysRunAssembly","importFromUploadURLs","getAssemblyOptions","locale","translator","i18n","translate","bind","prepareUpload","afterUpload","handleError","onFileUploadURLAvailable","onRestored","getPersistentData","validateParams","client","sockets","Error","JSON","parse","err","message","auth","key","fileIDs","normalizeAssemblyOptions","assemblyOptions","Array","isArray","fieldNames","forEach","fieldName","meta","all","map","fileID","getFile","promise","resolve","then","dedupeAssemblyOptions","list","dedupeMap","Object","create","stringify","push","keys","createAssembly","uploadID","pluginOptions","log","expectedFiles","length","assembly","state","getPluginState","assemblyList","uploadsAssemblies","concat","assembly_id","setPluginState","assemblies","attachAssemblyMetadata","tlMeta","assembly_url","filename","name","fieldname","tus","endpoint","tus_url","remote","test","serverUrl","newHost","uppyserver_url","path","url","replace","transloadit","newFile","files","getState","setState","emit","connectSocket","catch","shouldWait","reserveFiles","reserveFile","addFile","findFile","uploadedFile","getFiles","i","uploadURL","tus_upload_url","uploadUrl","is_tus_file","size","onFileUploadComplete","assemblyId","getAssembly","onResult","stepName","result","original_id","localId","entry","results","onAssemblyFinished","getAssemblyStatus","setData","uploads","emitEventsDiff","prevState","emitMissedEvents","newUploads","filter","hasOwnProperty","newResults","some","prev","newAssemblies","previousAssemblies","oldAssembly","diffAssemblyStatus","next","ok","upload_meta_data_extracted","error","pluginData","savedState","knownUploads","knownResults","loadAssemblies","assemblyIDs","assemblyID","reconnectSockets","restoreState","assembliesById","restored","newState","previousFiles","indexOf","socket","websocket_url","on","assembly_ssl_url","reject","mode","optionsPromise","allOptions","close","addResultData","finishedAssemblies","getAssemblyFiles","checkAllComplete","onAssemblyError","onImportError","removeListeners","off","install","addPreProcessor","addPostProcessor","use","resume","useFastRemoteRetry","metaFields","uninstall","removePreProcessor","removePostProcessor"],"mappings":"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","file":"index.js","sourcesContent":["const Translator = require('../../core/Translator')\r\nconst Plugin = require('../../core/Plugin')\r\nconst Tus = require('../Tus')\r\nconst Client = require('./Client')\r\nconst StatusSocket = require('./Socket')\r\n\r\nfunction defaultGetAssemblyOptions (file, options) {\r\n  return {\r\n    params: options.params,\r\n    signature: options.signature,\r\n    fields: options.fields\r\n  }\r\n}\r\n\r\nconst UPPY_SERVER = 'https://api2.transloadit.com/uppy-server'\r\n// Regex used to check if an uppy-server address is run by Transloadit.\r\nconst TL_UPPY_SERVER = /https?:\\/\\/api2(?:-\\w+)?\\.transloadit\\.com\\/uppy-server/\r\n\r\n/**\r\n * Upload files to Transloadit using Tus.\r\n */\r\nmodule.exports = class Transloadit extends Plugin {\r\n  constructor (uppy, opts) {\r\n    super(uppy, opts)\r\n    this.type = 'uploader'\r\n    this.id = 'Transloadit'\r\n    this.title = 'Transloadit'\r\n\r\n    const defaultLocale = {\r\n      strings: {\r\n        creatingAssembly: 'Preparing upload...',\r\n        creatingAssemblyFailed: 'Transloadit: Could not create Assembly',\r\n        encoding: 'Encoding...'\r\n      }\r\n    }\r\n\r\n    const defaultOptions = {\r\n      service: 'https://api2.transloadit.com',\r\n      waitForEncoding: false,\r\n      waitForMetadata: false,\r\n      alwaysRunAssembly: false,\r\n      importFromUploadURLs: false,\r\n      signature: null,\r\n      params: null,\r\n      fields: {},\r\n      getAssemblyOptions: defaultGetAssemblyOptions,\r\n      locale: defaultLocale\r\n    }\r\n\r\n    this.opts = Object.assign({}, defaultOptions, opts)\r\n\r\n    this.locale = Object.assign({}, defaultLocale, this.opts.locale)\r\n    this.locale.strings = Object.assign({}, defaultLocale.strings, this.opts.locale.strings)\r\n\r\n    this.translator = new Translator({ locale: this.locale })\r\n    this.i18n = this.translator.translate.bind(this.translator)\r\n\r\n    this.prepareUpload = this.prepareUpload.bind(this)\r\n    this.afterUpload = this.afterUpload.bind(this)\r\n    this.handleError = this.handleError.bind(this)\r\n    this.onFileUploadURLAvailable = this.onFileUploadURLAvailable.bind(this)\r\n    this.onRestored = this.onRestored.bind(this)\r\n    this.getPersistentData = this.getPersistentData.bind(this)\r\n\r\n    if (this.opts.params) {\r\n      this.validateParams(this.opts.params)\r\n    }\r\n\r\n    this.client = new Client({\r\n      service: this.opts.service\r\n    })\r\n    this.sockets = {}\r\n  }\r\n\r\n  validateParams (params) {\r\n    if (!params) {\r\n      throw new Error('Transloadit: The `params` option is required.')\r\n    }\r\n\r\n    if (typeof params === 'string') {\r\n      try {\r\n        params = JSON.parse(params)\r\n      } catch (err) {\r\n        // Tell the user that this is not an Uppy bug!\r\n        err.message = 'Transloadit: The `params` option is a malformed JSON string: ' +\r\n          err.message\r\n        throw err\r\n      }\r\n    }\r\n\r\n    if (!params.auth || !params.auth.key) {\r\n      throw new Error('Transloadit: The `params.auth.key` option is required. ' +\r\n        'You can find your Transloadit API key at https://transloadit.com/accounts/credentials.')\r\n    }\r\n  }\r\n\r\n  getAssemblyOptions (fileIDs) {\r\n    const options = this.opts\r\n\r\n    const normalizeAssemblyOptions = (file, assemblyOptions) => {\r\n      if (Array.isArray(assemblyOptions.fields)) {\r\n        const fieldNames = assemblyOptions.fields\r\n        assemblyOptions.fields = {}\r\n        fieldNames.forEach((fieldName) => {\r\n          assemblyOptions.fields[fieldName] = file.meta[fieldName]\r\n        })\r\n      }\r\n      if (!assemblyOptions.fields) {\r\n        assemblyOptions.fields = {}\r\n      }\r\n      return assemblyOptions\r\n    }\r\n\r\n    return Promise.all(\r\n      fileIDs.map((fileID) => {\r\n        const file = this.uppy.getFile(fileID)\r\n        const promise = Promise.resolve()\r\n          .then(() => options.getAssemblyOptions(file, options))\r\n          .then((assemblyOptions) => normalizeAssemblyOptions(file, assemblyOptions))\r\n        return promise.then((assemblyOptions) => {\r\n          this.validateParams(assemblyOptions.params)\r\n\r\n          return {\r\n            fileIDs: [fileID],\r\n            options: assemblyOptions\r\n          }\r\n        })\r\n      })\r\n    )\r\n  }\r\n\r\n  dedupeAssemblyOptions (list) {\r\n    const dedupeMap = Object.create(null)\r\n    list.forEach(({ fileIDs, options }) => {\r\n      const id = JSON.stringify(options)\r\n      if (dedupeMap[id]) {\r\n        dedupeMap[id].fileIDs.push(...fileIDs)\r\n      } else {\r\n        dedupeMap[id] = {\r\n          options,\r\n          fileIDs: [...fileIDs]\r\n        }\r\n      }\r\n    })\r\n\r\n    return Object.keys(dedupeMap).map((id) => dedupeMap[id])\r\n  }\r\n\r\n  createAssembly (fileIDs, uploadID, options) {\r\n    const pluginOptions = this.opts\r\n\r\n    this.uppy.log('[Transloadit] create Assembly')\r\n\r\n    return this.client.createAssembly({\r\n      params: options.params,\r\n      fields: options.fields,\r\n      expectedFiles: fileIDs.length,\r\n      signature: options.signature\r\n    }).then((assembly) => {\r\n      // Store the list of assemblies related to this upload.\r\n      const state = this.getPluginState()\r\n      const assemblyList = state.uploadsAssemblies[uploadID]\r\n      const uploadsAssemblies = Object.assign({}, state.uploadsAssemblies, {\r\n        [uploadID]: assemblyList.concat([ assembly.assembly_id ])\r\n      })\r\n\r\n      this.setPluginState({\r\n        assemblies: Object.assign(state.assemblies, {\r\n          [assembly.assembly_id]: assembly\r\n        }),\r\n        uploadsAssemblies\r\n      })\r\n\r\n      function attachAssemblyMetadata (file, assembly) {\r\n        // Attach meta parameters for the Tus plugin. See:\r\n        // https://github.com/tus/tusd/wiki/Uploading-to-Transloadit-using-tus#uploading-using-tus\r\n        const tlMeta = {\r\n          assembly_url: assembly.assembly_url,\r\n          filename: file.name,\r\n          fieldname: 'file'\r\n        }\r\n        const meta = Object.assign({}, file.meta, tlMeta)\r\n        // Add assembly-specific Tus endpoint.\r\n        const tus = Object.assign({}, file.tus, {\r\n          endpoint: assembly.tus_url\r\n        })\r\n\r\n        // Set uppy server location. We only add this, if 'file' has the attribute\r\n        // remote, because this is the criteria to identify remote files.\r\n        // We only replace the hostname for Transloadit's uppy-servers, so that\r\n        // people can self-host them while still using Transloadit for encoding.\r\n        let remote = file.remote\r\n        if (file.remote && TL_UPPY_SERVER.test(file.remote.serverUrl)) {\r\n          let newHost = assembly.uppyserver_url\r\n          let path = file.remote.url.replace(file.remote.serverUrl, '')\r\n          // remove tailing slash\r\n          newHost = newHost.replace(/\\/$/, '')\r\n          // remove leading slash\r\n          path = path.replace(/^\\//, '')\r\n\r\n          remote = Object.assign({}, file.remote, {\r\n            serverUrl: newHost,\r\n            url: `${newHost}/${path}`\r\n          })\r\n        }\r\n\r\n        const transloadit = {\r\n          assembly: assembly.assembly_id\r\n        }\r\n\r\n        const newFile = Object.assign({}, file, { transloadit })\r\n        // Only configure the Tus plugin if we are uploading straight to Transloadit (the default).\r\n        if (!pluginOptions.importFromUploadURLs) {\r\n          Object.assign(newFile, { meta, tus, remote })\r\n        }\r\n        return newFile\r\n      }\r\n\r\n      const files = Object.assign({}, this.uppy.getState().files)\r\n      fileIDs.forEach((id) => {\r\n        files[id] = attachAssemblyMetadata(files[id], assembly)\r\n      })\r\n\r\n      this.uppy.setState({ files })\r\n\r\n      this.uppy.emit('transloadit:assembly-created', assembly, fileIDs)\r\n\r\n      return this.connectSocket(assembly)\r\n        .then(() => assembly)\r\n    }).then((assembly) => {\r\n      this.uppy.log(`[Transloadit] Created Assembly ${assembly.assembly_id}`)\r\n      return assembly\r\n    }).catch((err) => {\r\n      // this.uppy.info(this.i18n('creatingAssemblyFailed'), 'error', 0)\r\n      err.message = `${this.i18n('creatingAssemblyFailed')}: ${err.message}`\r\n\r\n      // Reject the promise.\r\n      throw err\r\n    })\r\n  }\r\n\r\n  shouldWait () {\r\n    return this.opts.waitForEncoding || this.opts.waitForMetadata\r\n  }\r\n\r\n  /**\r\n   * Used when `importFromUploadURLs` is enabled: reserves all files in\r\n   * the assembly.\r\n   */\r\n  reserveFiles (assembly, fileIDs) {\r\n    return Promise.all(fileIDs.map((fileID) => {\r\n      const file = this.uppy.getFile(fileID)\r\n      return this.client.reserveFile(assembly, file)\r\n    }))\r\n  }\r\n\r\n  /**\r\n   * Used when `importFromUploadURLs` is enabled: adds files to the assembly\r\n   * once they have been fully uploaded.\r\n   */\r\n  onFileUploadURLAvailable (file) {\r\n    if (!file || !file.transloadit || !file.transloadit.assembly) {\r\n      return\r\n    }\r\n\r\n    const state = this.getPluginState()\r\n    const assembly = state.assemblies[file.transloadit.assembly]\r\n\r\n    this.client.addFile(assembly, file).catch((err) => {\r\n      this.uppy.log(err)\r\n      this.uppy.emit('transloadit:import-error', assembly, file.id, err)\r\n    })\r\n  }\r\n\r\n  findFile (uploadedFile) {\r\n    const files = this.uppy.getFiles()\r\n    for (let i = 0; i < files.length; i++) {\r\n      const file = files[i]\r\n      // Completed file upload.\r\n      if (file.uploadURL === uploadedFile.tus_upload_url) {\r\n        return file\r\n      }\r\n      // In-progress file upload.\r\n      if (file.tus && file.tus.uploadUrl === uploadedFile.tus_upload_url) {\r\n        return file\r\n      }\r\n      if (!uploadedFile.is_tus_file) {\r\n        // Fingers-crossed check for non-tus uploads, eg imported from S3.\r\n        if (file.name === uploadedFile.name && file.size === uploadedFile.size) {\r\n          return file\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  onFileUploadComplete (assemblyId, uploadedFile) {\r\n    const state = this.getPluginState()\r\n    const file = this.findFile(uploadedFile)\r\n    if (!file) {\r\n      this.uppy.log('[Transloadit] Couldn’t file the file, it was likely removed in the process')\r\n      return\r\n    }\r\n    this.setPluginState({\r\n      files: Object.assign({}, state.files, {\r\n        [uploadedFile.id]: {\r\n          assembly: assemblyId,\r\n          id: file.id,\r\n          uploadedFile\r\n        }\r\n      })\r\n    })\r\n    this.uppy.emit('transloadit:upload', uploadedFile, this.getAssembly(assemblyId))\r\n  }\r\n\r\n  onResult (assemblyId, stepName, result) {\r\n    const state = this.getPluginState()\r\n    const file = state.files[result.original_id]\r\n    // The `file` may not exist if an import robot was used instead of a file upload.\r\n    result.localId = file ? file.id : null\r\n\r\n    const entry = {\r\n      result,\r\n      stepName,\r\n      id: result.id,\r\n      assembly: assemblyId\r\n    }\r\n\r\n    this.setPluginState({\r\n      results: [...state.results, entry]\r\n    })\r\n    this.uppy.emit('transloadit:result', stepName, result, this.getAssembly(assemblyId))\r\n  }\r\n\r\n  onAssemblyFinished (url) {\r\n    this.client.getAssemblyStatus(url).then((assembly) => {\r\n      const state = this.getPluginState()\r\n      this.setPluginState({\r\n        assemblies: Object.assign({}, state.assemblies, {\r\n          [assembly.assembly_id]: assembly\r\n        })\r\n      })\r\n      this.uppy.emit('transloadit:complete', assembly)\r\n    })\r\n  }\r\n\r\n  getPersistentData (setData) {\r\n    const state = this.getPluginState()\r\n    const assemblies = state.assemblies\r\n    const uploadsAssemblies = state.uploadsAssemblies\r\n    const uploads = Object.keys(state.files)\r\n    const results = state.results.map((result) => result.id)\r\n\r\n    setData({\r\n      [this.id]: {\r\n        assemblies,\r\n        uploadsAssemblies,\r\n        uploads,\r\n        results\r\n      }\r\n    })\r\n  }\r\n\r\n  /**\r\n   * Emit the necessary events that must have occured to get from the `prevState`,\r\n   * to the current state.\r\n   * For completed uploads, `transloadit:upload` is emitted.\r\n   * For new results, `transloadit:result` is emitted.\r\n   * For completed or errored assemblies, `transloadit:complete` or `transloadit:assembly-error` is emitted.\r\n   */\r\n  emitEventsDiff (prevState) {\r\n    const opts = this.opts\r\n    const state = this.getPluginState()\r\n\r\n    const emitMissedEvents = () => {\r\n      // Emit events for completed uploads and completed results\r\n      // that we've missed while we were away.\r\n      const newUploads = Object.keys(state.files).filter((fileID) => {\r\n        return !prevState.files.hasOwnProperty(fileID)\r\n      }).map((fileID) => state.files[fileID])\r\n      const newResults = state.results.filter((result) => {\r\n        return !prevState.results.some((prev) => prev.id === result.id)\r\n      })\r\n\r\n      this.uppy.log('[Transloadit] New fully uploaded files since restore:')\r\n      this.uppy.log(newUploads)\r\n      newUploads.forEach(({ assembly, uploadedFile }) => {\r\n        this.uppy.log(`[Transloadit]  emitting transloadit:upload ${uploadedFile.id}`)\r\n        this.uppy.emit('transloadit:upload', uploadedFile, this.getAssembly(assembly))\r\n      })\r\n      this.uppy.log('[Transloadit] New results since restore:')\r\n      this.uppy.log(newResults)\r\n      newResults.forEach(({ assembly, stepName, result, id }) => {\r\n        this.uppy.log(`[Transloadit]  emitting transloadit:result ${stepName}, ${id}`)\r\n        this.uppy.emit('transloadit:result', stepName, result, this.getAssembly(assembly))\r\n      })\r\n\r\n      const newAssemblies = state.assemblies\r\n      const previousAssemblies = prevState.assemblies\r\n      this.uppy.log('[Transloadit] Current Assembly status after restore')\r\n      this.uppy.log(newAssemblies)\r\n      this.uppy.log('[Transloadit] Assembly status before restore')\r\n      this.uppy.log(previousAssemblies)\r\n      Object.keys(newAssemblies).forEach((assemblyId) => {\r\n        const oldAssembly = previousAssemblies[assemblyId]\r\n        diffAssemblyStatus(oldAssembly, newAssemblies[assemblyId])\r\n      })\r\n    }\r\n\r\n    // Emit events for assemblies that have completed or errored while we were away.\r\n    const diffAssemblyStatus = (prev, next) => {\r\n      this.uppy.log('[Transloadit] Diff assemblies')\r\n      this.uppy.log(prev)\r\n      this.uppy.log(next)\r\n\r\n      if (opts.waitForEncoding && next.ok === 'ASSEMBLY_COMPLETED' && prev.ok !== 'ASSEMBLY_COMPLETED') {\r\n        this.uppy.log(`[Transloadit]  Emitting transloadit:complete for ${next.assembly_id}`)\r\n        this.uppy.log(next)\r\n        this.uppy.emit('transloadit:complete', next)\r\n      } else if (opts.waitForMetadata && next.upload_meta_data_extracted && !prev.upload_meta_data_extracted) {\r\n        this.uppy.log(`[Transloadit]  Emitting transloadit:complete after metadata extraction for ${next.assembly_id}`)\r\n        this.uppy.log(next)\r\n        this.uppy.emit('transloadit:complete', next)\r\n      }\r\n\r\n      if (next.error && !prev.error) {\r\n        this.uppy.log(`[Transloadit]  !!! Emitting transloadit:assembly-error for ${next.assembly_id}`)\r\n        this.uppy.log(next)\r\n        this.uppy.emit('transloadit:assembly-error', next, new Error(next.message))\r\n      }\r\n    }\r\n\r\n    emitMissedEvents()\r\n  }\r\n\r\n  onRestored (pluginData) {\r\n    const savedState = pluginData && pluginData[this.id] ? pluginData[this.id] : {}\r\n    const knownUploads = savedState.files || []\r\n    const knownResults = savedState.results || []\r\n    const previousAssemblies = savedState.assemblies || {}\r\n    const uploadsAssemblies = savedState.uploadsAssemblies || {}\r\n\r\n    if (Object.keys(uploadsAssemblies).length === 0) {\r\n      // Nothing to restore.\r\n      return\r\n    }\r\n\r\n    // Fetch up-to-date assembly statuses.\r\n    const loadAssemblies = () => {\r\n      const assemblyIDs = []\r\n      Object.keys(uploadsAssemblies).forEach((uploadID) => {\r\n        assemblyIDs.push(...uploadsAssemblies[uploadID])\r\n      })\r\n\r\n      return Promise.all(\r\n        assemblyIDs.map((assemblyID) => {\r\n          const url = `https://api2.transloadit.com/assemblies/${assemblyID}`\r\n          return this.client.getAssemblyStatus(url)\r\n        })\r\n      )\r\n    }\r\n\r\n    const reconnectSockets = (assemblies) => {\r\n      return Promise.all(assemblies.map((assembly) => {\r\n        // No need to connect to the socket if the assembly has completed by now.\r\n        if (assembly.ok === 'ASSEMBLY_COMPLETE') {\r\n          return null\r\n        }\r\n        return this.connectSocket(assembly)\r\n      }))\r\n    }\r\n\r\n    // Convert loaded assembly statuses to a Transloadit plugin state object.\r\n    const restoreState = (assemblies) => {\r\n      const assembliesById = {}\r\n      const files = {}\r\n      const results = []\r\n      assemblies.forEach((assembly) => {\r\n        assembliesById[assembly.assembly_id] = assembly\r\n\r\n        assembly.uploads.forEach((uploadedFile) => {\r\n          const file = this.findFile(uploadedFile)\r\n          files[uploadedFile.id] = {\r\n            id: file.id,\r\n            assembly: assembly.assembly_id,\r\n            uploadedFile\r\n          }\r\n        })\r\n\r\n        const state = this.getPluginState()\r\n        Object.keys(assembly.results).forEach((stepName) => {\r\n          assembly.results[stepName].forEach((result) => {\r\n            const file = state.files[result.original_id]\r\n            result.localId = file ? file.id : null\r\n            results.push({\r\n              id: result.id,\r\n              result,\r\n              stepName,\r\n              assembly: assembly.assembly_id\r\n            })\r\n          })\r\n        })\r\n      })\r\n\r\n      this.setPluginState({\r\n        assemblies: assembliesById,\r\n        files: files,\r\n        results: results,\r\n        uploadsAssemblies: uploadsAssemblies\r\n      })\r\n    }\r\n\r\n    // Restore all assembly state.\r\n    this.restored = Promise.resolve()\r\n      .then(loadAssemblies)\r\n      .then((assemblies) => {\r\n        restoreState(assemblies)\r\n        return reconnectSockets(assemblies)\r\n      })\r\n      .then(() => {\r\n        // Return a callback that will be called by `afterUpload`\r\n        // once it has attached event listeners etc.\r\n        const newState = this.getPluginState()\r\n        const previousFiles = {}\r\n        knownUploads.forEach((id) => {\r\n          previousFiles[id] = newState.files[id]\r\n        })\r\n        return () => this.emitEventsDiff({\r\n          assemblies: previousAssemblies,\r\n          files: previousFiles,\r\n          results: newState.results.filter(({ id }) => knownResults.indexOf(id) !== -1),\r\n          uploadsAssemblies\r\n        })\r\n      })\r\n\r\n    this.restored.then(() => {\r\n      this.restored = null\r\n    })\r\n  }\r\n\r\n  connectSocket (assembly) {\r\n    const socket = new StatusSocket(\r\n      assembly.websocket_url,\r\n      assembly\r\n    )\r\n    this.sockets[assembly.assembly_id] = socket\r\n\r\n    socket.on('upload', this.onFileUploadComplete.bind(this, assembly.assembly_id))\r\n    socket.on('error', (error) => {\r\n      this.uppy.emit('transloadit:assembly-error', assembly, error)\r\n    })\r\n\r\n    socket.on('executing', () => {\r\n      this.uppy.emit('transloadit:assembly-executing', assembly)\r\n    })\r\n\r\n    if (this.opts.waitForEncoding) {\r\n      socket.on('result', this.onResult.bind(this, assembly.assembly_id))\r\n    }\r\n\r\n    if (this.opts.waitForEncoding) {\r\n      socket.on('finished', () => {\r\n        this.onAssemblyFinished(assembly.assembly_ssl_url)\r\n      })\r\n    } else if (this.opts.waitForMetadata) {\r\n      socket.on('metadata', () => {\r\n        this.onAssemblyFinished(assembly.assembly_ssl_url)\r\n      })\r\n    }\r\n\r\n    return new Promise((resolve, reject) => {\r\n      socket.on('connect', resolve)\r\n      socket.on('error', reject)\r\n    }).then(() => {\r\n      this.uppy.log('[Transloadit] Socket is ready')\r\n    })\r\n  }\r\n\r\n  prepareUpload (fileIDs, uploadID) {\r\n    // Only use files without errors\r\n    fileIDs = fileIDs.filter((file) => !file.error)\r\n\r\n    fileIDs.forEach((fileID) => {\r\n      const file = this.uppy.getFile(fileID)\r\n      this.uppy.emit('preprocess-progress', file, {\r\n        mode: 'indeterminate',\r\n        message: this.i18n('creatingAssembly')\r\n      })\r\n    })\r\n\r\n    const createAssembly = ({ fileIDs, options }) => {\r\n      return this.createAssembly(fileIDs, uploadID, options).then((assembly) => {\r\n        if (this.opts.importFromUploadURLs) {\r\n          return this.reserveFiles(assembly, fileIDs)\r\n        }\r\n      }).then(() => {\r\n        fileIDs.forEach((fileID) => {\r\n          const file = this.uppy.getFile(fileID)\r\n          this.uppy.emit('preprocess-complete', file)\r\n        })\r\n      }).catch((err) => {\r\n        // Clear preprocessing state when the assembly could not be created,\r\n        // otherwise the UI gets confused about the lingering progress keys\r\n        fileIDs.forEach((fileID) => {\r\n          const file = this.uppy.getFile(fileID)\r\n          this.uppy.emit('preprocess-complete', file)\r\n          this.uppy.emit('upload-error', file, err)\r\n        })\r\n        throw err\r\n      })\r\n    }\r\n\r\n    const state = this.getPluginState()\r\n    const uploadsAssemblies = Object.assign({},\r\n      state.uploadsAssemblies,\r\n      { [uploadID]: [] })\r\n    this.setPluginState({ uploadsAssemblies })\r\n\r\n    let optionsPromise\r\n    if (fileIDs.length > 0) {\r\n      optionsPromise = Promise.resolve(this.getAssemblyOptions(fileIDs))\r\n        .then((allOptions) => this.dedupeAssemblyOptions(allOptions))\r\n    } else if (this.opts.alwaysRunAssembly) {\r\n      optionsPromise = Promise.resolve(\r\n        this.opts.getAssemblyOptions(null, this.opts)\r\n      ).then((options) => {\r\n        this.validateParams(options.params)\r\n        return [\r\n          { fileIDs, options }\r\n        ]\r\n      })\r\n    } else {\r\n      // If there are no files and we do not `alwaysRunAssembly`,\r\n      // don't do anything.\r\n      return Promise.resolve()\r\n    }\r\n\r\n    return optionsPromise.then(\r\n      (assemblies) => Promise.all(\r\n        assemblies.map(createAssembly)\r\n      ),\r\n      // If something went wrong before any assemblies could be created,\r\n      // clear all processing state.\r\n      (err) => {\r\n        fileIDs.forEach((fileID) => {\r\n          const file = this.uppy.getFile(fileID)\r\n          this.uppy.emit('preprocess-complete', file)\r\n          this.uppy.emit('upload-error', file, err)\r\n        })\r\n        throw err\r\n      }\r\n    )\r\n  }\r\n\r\n  afterUpload (fileIDs, uploadID) {\r\n    // Only use files without errors\r\n    fileIDs = fileIDs.filter((file) => !file.error)\r\n\r\n    const state = this.getPluginState()\r\n\r\n    // If we're still restoring state, wait for that to be done.\r\n    if (this.restored) {\r\n      return this.restored.then((emitMissedEvents) => {\r\n        const promise = this.afterUpload(fileIDs, uploadID)\r\n        emitMissedEvents()\r\n        return promise\r\n      })\r\n    }\r\n\r\n    const assemblyIDs = state.uploadsAssemblies[uploadID]\r\n\r\n    // If we don't have to wait for encoding metadata or results, we can close\r\n    // the socket immediately and finish the upload.\r\n    if (!this.shouldWait()) {\r\n      assemblyIDs.forEach((assemblyID) => {\r\n        const socket = this.sockets[assemblyID]\r\n        socket.close()\r\n      })\r\n      const assemblies = assemblyIDs.map((id) => this.getAssembly(id))\r\n      this.uppy.addResultData(uploadID, { transloadit: assemblies })\r\n      return Promise.resolve()\r\n    }\r\n\r\n    // If no assemblies were created for this upload, we also do not have to wait.\r\n    // There's also no sockets or anything to close, so just return immediately.\r\n    if (assemblyIDs.length === 0) {\r\n      this.uppy.addResultData(uploadID, { transloadit: [] })\r\n      return Promise.resolve()\r\n    }\r\n\r\n    let finishedAssemblies = 0\r\n\r\n    return new Promise((resolve, reject) => {\r\n      fileIDs.forEach((fileID) => {\r\n        const file = this.uppy.getFile(fileID)\r\n        this.uppy.emit('postprocess-progress', file, {\r\n          mode: 'indeterminate',\r\n          message: this.i18n('encoding')\r\n        })\r\n      })\r\n\r\n      const onAssemblyFinished = (assembly) => {\r\n        // An assembly for a different upload just finished. We can ignore it.\r\n        if (assemblyIDs.indexOf(assembly.assembly_id) === -1) {\r\n          this.uppy.log(`[Transloadit] afterUpload(): Ignoring finished Assembly ${assembly.assembly_id}`)\r\n          return\r\n        }\r\n        this.uppy.log(`[Transloadit] afterUpload(): Got Assembly finish ${assembly.assembly_id}`)\r\n\r\n        // TODO set the `file.uploadURL` to a result?\r\n        // We will probably need an option here so the plugin user can tell us\r\n        // which result to pick…?\r\n\r\n        const files = this.getAssemblyFiles(assembly.assembly_id)\r\n        files.forEach((file) => {\r\n          this.uppy.emit('postprocess-complete', file)\r\n        })\r\n\r\n        checkAllComplete()\r\n      }\r\n\r\n      const onAssemblyError = (assembly, error) => {\r\n        // An assembly for a different upload just errored. We can ignore it.\r\n        if (assemblyIDs.indexOf(assembly.assembly_id) === -1) {\r\n          this.uppy.log(`[Transloadit] afterUpload(): Ignoring errored Assembly ${assembly.assembly_id}`)\r\n          return\r\n        }\r\n        this.uppy.log(`[Transloadit] afterUpload(): Got Assembly error ${assembly.assembly_id}`)\r\n        this.uppy.log(error)\r\n        // this.uppy.info({\r\n        //   message: error.code,\r\n        //   details: error.status.reason\r\n        // }, 'error', 5000)\r\n\r\n        // Clear postprocessing state for all our files.\r\n        const files = this.getAssemblyFiles(assembly.assembly_id)\r\n        files.forEach((file) => {\r\n          // TODO Maybe make a postprocess-error event here?\r\n          this.uppy.emit('upload-error', file, error)\r\n\r\n          this.uppy.emit('postprocess-complete', file)\r\n        })\r\n\r\n        checkAllComplete()\r\n      }\r\n\r\n      const onImportError = (assembly, fileID, error) => {\r\n        if (assemblyIDs.indexOf(assembly.assembly_id) === -1) {\r\n          return\r\n        }\r\n\r\n        // Not sure if we should be doing something when it's just one file failing.\r\n        // ATM, the only options are 1) ignoring or 2) failing the entire upload.\r\n        // I think failing the upload is better than silently ignoring.\r\n        // In the future we should maybe have a way to resolve uploads with some failures,\r\n        // like returning an object with `{ successful, failed }` uploads.\r\n        onAssemblyError(assembly, error)\r\n      }\r\n\r\n      const checkAllComplete = () => {\r\n        finishedAssemblies += 1\r\n        if (finishedAssemblies === assemblyIDs.length) {\r\n          // We're done, these listeners can be removed\r\n          removeListeners()\r\n          const assemblies = assemblyIDs.map((id) => this.getAssembly(id))\r\n          this.uppy.addResultData(uploadID, { transloadit: assemblies })\r\n          resolve()\r\n        }\r\n      }\r\n\r\n      const removeListeners = () => {\r\n        this.uppy.off('transloadit:complete', onAssemblyFinished)\r\n        this.uppy.off('transloadit:assembly-error', onAssemblyError)\r\n        this.uppy.off('transloadit:import-error', onImportError)\r\n      }\r\n\r\n      this.uppy.on('transloadit:complete', onAssemblyFinished)\r\n      this.uppy.on('transloadit:assembly-error', onAssemblyError)\r\n      this.uppy.on('transloadit:import-error', onImportError)\r\n    }).then((result) => {\r\n      // Clean up uploadID → assemblyIDs, they're no longer going to be used anywhere.\r\n      const state = this.getPluginState()\r\n      const uploadsAssemblies = Object.assign({}, state.uploadsAssemblies)\r\n      delete uploadsAssemblies[uploadID]\r\n      this.setPluginState({ uploadsAssemblies })\r\n\r\n      return result\r\n    })\r\n  }\r\n\r\n  handleError (err, uploadID) {\r\n    this.uppy.log('[Transloadit] handleError')\r\n    this.uppy.log(err)\r\n    this.uppy.log(uploadID)\r\n    const state = this.getPluginState()\r\n    const assemblyIDs = state.uploadsAssemblies[uploadID]\r\n\r\n    assemblyIDs.forEach((assemblyID) => {\r\n      if (this.sockets[assemblyID]) {\r\n        this.sockets[assemblyID].close()\r\n      }\r\n    })\r\n  }\r\n\r\n  install () {\r\n    this.uppy.addPreProcessor(this.prepareUpload)\r\n    this.uppy.addPostProcessor(this.afterUpload)\r\n\r\n    // We may need to close socket.io connections on error.\r\n    this.uppy.on('error', this.handleError)\r\n\r\n    if (this.opts.importFromUploadURLs) {\r\n      // No uploader needed when importing; instead we take the upload URL from an existing uploader.\r\n      this.uppy.on('upload-success', this.onFileUploadURLAvailable)\r\n    } else {\r\n      this.uppy.use(Tus, {\r\n        // Disable tus-js-client fingerprinting, otherwise uploading the same file at different times\r\n        // will upload to the same assembly.\r\n        resume: false,\r\n        // Disable Uppy Server's retry optimisation; we need to change the endpoint on retry\r\n        // so it can't just reuse the same tus.Upload instance server-side.\r\n        useFastRemoteRetry: false,\r\n        // Only send assembly metadata to the tus endpoint.\r\n        metaFields: ['assembly_url', 'filename', 'fieldname']\r\n      })\r\n    }\r\n\r\n    this.uppy.on('restore:get-data', this.getPersistentData)\r\n    this.uppy.on('restored', this.onRestored)\r\n\r\n    this.setPluginState({\r\n      // Contains assembly status objects, indexed by their ID.\r\n      assemblies: {},\r\n      // Contains arrays of assembly IDs, indexed by the upload ID that they belong to.\r\n      uploadsAssemblies: {},\r\n      // Contains file data from Transloadit, indexed by their Transloadit-assigned ID.\r\n      files: {},\r\n      // Contains result data from Transloadit.\r\n      results: []\r\n    })\r\n  }\r\n\r\n  uninstall () {\r\n    this.uppy.removePreProcessor(this.prepareUpload)\r\n    this.uppy.removePostProcessor(this.afterUpload)\r\n    this.uppy.off('error', this.handleError)\r\n\r\n    if (this.opts.importFromUploadURLs) {\r\n      this.uppy.off('upload-success', this.onFileUploadURLAvailable)\r\n    }\r\n  }\r\n\r\n  getAssembly (id) {\r\n    const state = this.getPluginState()\r\n    return state.assemblies[id]\r\n  }\r\n\r\n  getAssemblyFiles (assemblyID) {\r\n    return this.uppy.getFiles().filter((file) => {\r\n      return file && file.transloadit && file.transloadit.assembly === assemblyID\r\n    })\r\n  }\r\n}\r\n\r\nmodule.exports.UPPY_SERVER = UPPY_SERVER\r\n"]}