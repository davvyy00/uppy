{"version":3,"sources":["../../../src/plugins/GoldenRetriever/IndexedDBStore.js"],"names":["prettyBytes","require","indexedDB","window","webkitIndexedDB","mozIndexedDB","OIndexedDB","msIndexedDB","isSupported","DB_NAME","STORE_NAME","DEFAULT_EXPIRY","DB_VERSION","migrateExpiration","store","request","openCursor","onsuccess","event","cursor","target","result","entry","value","expires","Date","now","update","connect","dbName","open","resolve","reject","onupgradeneeded","db","transaction","currentTarget","oldVersion","createObjectStore","keyPath","createIndex","unique","objectStore","oncomplete","onerror","waitForRequest","cleanedUp","IndexedDBStore","opts","storeName","maxFileSize","maxTotalSize","name","createConnection","ready","cleanup","then","key","fileID","list","index","getAll","IDBKeyRange","only","files","forEach","file","data","get","id","getSize","size","continue","Error","put","add","delete","upperBound","console","log","close","module","exports"],"mappings":"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","file":"IndexedDBStore.js","sourcesContent":["const prettyBytes = require('prettier-bytes')\r\nconst indexedDB = typeof window !== 'undefined' &&\r\n  (window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB || window.OIndexedDB || window.msIndexedDB)\r\n\r\nconst isSupported = !!indexedDB\r\n\r\nconst DB_NAME = 'uppy-blobs'\r\nconst STORE_NAME = 'files' // maybe have a thumbnail store in the future\r\nconst DEFAULT_EXPIRY = 24 * 60 * 60 * 1000 // 24 hours\r\nconst DB_VERSION = 3\r\n\r\n// Set default `expires` dates on existing stored blobs.\r\nfunction migrateExpiration (store) {\r\n  const request = store.openCursor()\r\n  request.onsuccess = (event) => {\r\n    const cursor = event.target.result\r\n    if (!cursor) {\r\n      return\r\n    }\r\n    const entry = cursor.value\r\n    entry.expires = Date.now() + DEFAULT_EXPIRY\r\n    cursor.update(entry)\r\n  }\r\n}\r\n\r\nfunction connect (dbName) {\r\n  const request = indexedDB.open(dbName, DB_VERSION)\r\n  return new Promise((resolve, reject) => {\r\n    request.onupgradeneeded = (event) => {\r\n      const db = event.target.result\r\n      const transaction = event.currentTarget.transaction\r\n\r\n      if (event.oldVersion < 2) {\r\n        // Added in v2: DB structure changed to a single shared object store\r\n        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' })\r\n        store.createIndex('store', 'store', { unique: false })\r\n      }\r\n\r\n      if (event.oldVersion < 3) {\r\n        // Added in v3\r\n        const store = transaction.objectStore(STORE_NAME)\r\n        store.createIndex('expires', 'expires', { unique: false })\r\n\r\n        migrateExpiration(store)\r\n      }\r\n\r\n      transaction.oncomplete = () => {\r\n        resolve(db)\r\n      }\r\n    }\r\n    request.onsuccess = (event) => {\r\n      resolve(event.target.result)\r\n    }\r\n    request.onerror = reject\r\n  })\r\n}\r\n\r\nfunction waitForRequest (request) {\r\n  return new Promise((resolve, reject) => {\r\n    request.onsuccess = (event) => {\r\n      resolve(event.target.result)\r\n    }\r\n    request.onerror = reject\r\n  })\r\n}\r\n\r\nlet cleanedUp = false\r\nclass IndexedDBStore {\r\n  constructor (opts) {\r\n    this.opts = Object.assign({\r\n      dbName: DB_NAME,\r\n      storeName: 'default',\r\n      expires: DEFAULT_EXPIRY, // 24 hours\r\n      maxFileSize: 10 * 1024 * 1024, // 10 MB\r\n      maxTotalSize: 300 * 1024 * 1024 // 300 MB\r\n    }, opts)\r\n\r\n    this.name = this.opts.storeName\r\n\r\n    const createConnection = () => {\r\n      return connect(this.opts.dbName)\r\n    }\r\n\r\n    if (!cleanedUp) {\r\n      cleanedUp = true\r\n      this.ready = IndexedDBStore.cleanup()\r\n        .then(createConnection, createConnection)\r\n    } else {\r\n      this.ready = createConnection()\r\n    }\r\n  }\r\n\r\n  key (fileID) {\r\n    return `${this.name}!${fileID}`\r\n  }\r\n\r\n  /**\r\n   * List all file blobs currently in the store.\r\n   */\r\n  list () {\r\n    return this.ready.then((db) => {\r\n      const transaction = db.transaction([STORE_NAME], 'readonly')\r\n      const store = transaction.objectStore(STORE_NAME)\r\n      const request = store.index('store')\r\n        .getAll(IDBKeyRange.only(this.name))\r\n      return waitForRequest(request)\r\n    }).then((files) => {\r\n      const result = {}\r\n      files.forEach((file) => {\r\n        result[file.fileID] = file.data\r\n      })\r\n      return result\r\n    })\r\n  }\r\n\r\n  /**\r\n   * Get one file blob from the store.\r\n   */\r\n  get (fileID) {\r\n    return this.ready.then((db) => {\r\n      const transaction = db.transaction([STORE_NAME], 'readonly')\r\n      const request = transaction.objectStore(STORE_NAME)\r\n        .get(this.key(fileID))\r\n      return waitForRequest(request)\r\n    }).then((result) => ({\r\n      id: result.data.fileID,\r\n      data: result.data.data\r\n    }))\r\n  }\r\n\r\n  /**\r\n   * Get the total size of all stored files.\r\n   *\r\n   * @private\r\n   */\r\n  getSize () {\r\n    return this.ready.then((db) => {\r\n      const transaction = db.transaction([STORE_NAME], 'readonly')\r\n      const store = transaction.objectStore(STORE_NAME)\r\n      const request = store.index('store')\r\n        .openCursor(IDBKeyRange.only(this.name))\r\n      return new Promise((resolve, reject) => {\r\n        let size = 0\r\n        request.onsuccess = (event) => {\r\n          const cursor = event.target.result\r\n          if (cursor) {\r\n            size += cursor.value.data.size\r\n            cursor.continue()\r\n          } else {\r\n            resolve(size)\r\n          }\r\n        }\r\n        request.onerror = () => {\r\n          reject(new Error('Could not retrieve stored blobs size'))\r\n        }\r\n      })\r\n    })\r\n  }\r\n\r\n  /**\r\n   * Save a file in the store.\r\n   */\r\n  put (file) {\r\n    if (file.data.size > this.opts.maxFileSize) {\r\n      return Promise.reject(new Error('File is too big to store.'))\r\n    }\r\n    return this.getSize().then((size) => {\r\n      if (size > this.opts.maxTotalSize) {\r\n        return Promise.reject(new Error('No space left'))\r\n      }\r\n      return this.ready\r\n    }).then((db) => {\r\n      const transaction = db.transaction([STORE_NAME], 'readwrite')\r\n      const request = transaction.objectStore(STORE_NAME).add({\r\n        id: this.key(file.id),\r\n        fileID: file.id,\r\n        store: this.name,\r\n        expires: Date.now() + this.opts.expires,\r\n        data: file.data\r\n      })\r\n      return waitForRequest(request)\r\n    })\r\n  }\r\n\r\n  /**\r\n   * Delete a file blob from the store.\r\n   */\r\n  delete (fileID) {\r\n    return this.ready.then((db) => {\r\n      const transaction = db.transaction([STORE_NAME], 'readwrite')\r\n      const request = transaction.objectStore(STORE_NAME)\r\n        .delete(this.key(fileID))\r\n      return waitForRequest(request)\r\n    })\r\n  }\r\n\r\n  /**\r\n   * Delete all stored blobs that have an expiry date that is before Date.now().\r\n   * This is a static method because it deletes expired blobs from _all_ Uppy instances.\r\n   */\r\n  static cleanup () {\r\n    return connect(DB_NAME).then((db) => {\r\n      const transaction = db.transaction([STORE_NAME], 'readwrite')\r\n      const store = transaction.objectStore(STORE_NAME)\r\n      const request = store.index('expires')\r\n        .openCursor(IDBKeyRange.upperBound(Date.now()))\r\n      return new Promise((resolve, reject) => {\r\n        request.onsuccess = (event) => {\r\n          const cursor = event.target.result\r\n          if (cursor) {\r\n            const entry = cursor.value\r\n            console.log(\r\n              '[IndexedDBStore] Deleting record', entry.fileID,\r\n              'of size', prettyBytes(entry.data.size),\r\n              '- expired on', new Date(entry.expires))\r\n            cursor.delete() // Ignoring return value … it's not terrible if this goes wrong.\r\n            cursor.continue()\r\n          } else {\r\n            resolve(db)\r\n          }\r\n        }\r\n        request.onerror = reject\r\n      })\r\n    }).then((db) => {\r\n      db.close()\r\n    })\r\n  }\r\n}\r\n\r\nIndexedDBStore.isSupported = isSupported\r\n\r\nmodule.exports = IndexedDBStore\r\n"]}