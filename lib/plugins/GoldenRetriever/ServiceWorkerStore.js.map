{"version":3,"sources":["../../../src/plugins/GoldenRetriever/ServiceWorkerStore.js"],"names":["isSupported","navigator","waitForServiceWorker","resolve","reject","Error","serviceWorker","controller","addEventListener","ServiceWorkerStore","opts","ready","name","storeName","list","defer","promise","console","log","onMessage","event","data","store","type","files","removeEventListener","then","postMessage","put","file","delete","fileID","module","exports"],"mappings":";;;;AAAA,IAAMA,cAAc,OAAOC,SAAP,KAAqB,WAArB,IAAoC,mBAAmBA,SAA3E;;AAEA,SAASC,oBAAT,GAAiC;AAC/B,SAAO,aAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,QAAI,CAACJ,WAAL,EAAkB;AAChBI,aAAO,IAAIC,KAAJ,CAAU,aAAV,CAAP;AACD,KAFD,MAEO,IAAIJ,UAAUK,aAAV,CAAwBC,UAA5B,EAAwC;AAC7C;AACAJ;AACD,KAHM,MAGA;AACLF,gBAAUK,aAAV,CAAwBE,gBAAxB,CAAyC,kBAAzC,EAA6D,YAAM;AACjEL;AACD,OAFD;AAGD;AACF,GAXM,CAAP;AAYD;;IAEKM,kB;AACJ,8BAAaC,IAAb,EAAmB;AAAA;;AACjB,SAAKC,KAAL,GAAaT,sBAAb;AACA,SAAKU,IAAL,GAAYF,KAAKG,SAAjB;AACD;;+BAEDC,I,mBAAQ;AAAA;;AACN,QAAMC,QAAQ,EAAd;AACA,QAAMC,UAAU,aAAY,UAACb,OAAD,EAAUC,MAAV,EAAqB;AAC/CW,YAAMZ,OAAN,GAAgBA,OAAhB;AACAY,YAAMX,MAAN,GAAeA,MAAf;AACD,KAHe,CAAhB;;AAKAa,YAAQC,GAAR,CAAY,0CAAZ;AACA,QAAMC,YAAY,SAAZA,SAAY,CAACC,KAAD,EAAW;AAC3B,UAAIA,MAAMC,IAAN,CAAWC,KAAX,KAAqB,MAAKV,IAA9B,EAAoC;AAClC;AACD;AACD,cAAQQ,MAAMC,IAAN,CAAWE,IAAnB;AACE,aAAK,gBAAL;AACER,gBAAMZ,OAAN,CAAciB,MAAMC,IAAN,CAAWG,KAAzB;AACAvB,oBAAUK,aAAV,CAAwBmB,mBAAxB,CAA4C,SAA5C,EAAuDN,SAAvD;AACA;AAJJ;AAMD,KAVD;;AAYA,SAAKR,KAAL,CAAWe,IAAX,CAAgB,YAAM;AACpBzB,gBAAUK,aAAV,CAAwBE,gBAAxB,CAAyC,SAAzC,EAAoDW,SAApD;;AAEAlB,gBAAUK,aAAV,CAAwBC,UAAxB,CAAmCoB,WAAnC,CAA+C;AAC7CJ,cAAM,gBADuC;AAE7CD,eAAO,MAAKV;AAFiC,OAA/C;AAID,KAPD;;AASA,WAAOI,OAAP;AACD,G;;+BAEDY,G,gBAAKC,I,EAAM;AAAA;;AACT,WAAO,KAAKlB,KAAL,CAAWe,IAAX,CAAgB,YAAM;AAC3BzB,gBAAUK,aAAV,CAAwBC,UAAxB,CAAmCoB,WAAnC,CAA+C;AAC7CJ,cAAM,eADuC;AAE7CD,eAAO,OAAKV,IAFiC;AAG7CiB,cAAMA;AAHuC,OAA/C;AAKD,KANM,CAAP;AAOD,G;;+BAEDC,M,oBAAQC,M,EAAQ;AAAA;;AACd,WAAO,KAAKpB,KAAL,CAAWe,IAAX,CAAgB,YAAM;AAC3BzB,gBAAUK,aAAV,CAAwBC,UAAxB,CAAmCoB,WAAnC,CAA+C;AAC7CJ,cAAM,kBADuC;AAE7CD,eAAO,OAAKV,IAFiC;AAG7CmB,gBAAQA;AAHqC,OAA/C;AAKD,KANM,CAAP;AAOD,G;;;;;AAGHtB,mBAAmBT,WAAnB,GAAiCA,WAAjC;;AAEAgC,OAAOC,OAAP,GAAiBxB,kBAAjB","file":"ServiceWorkerStore.js","sourcesContent":["const isSupported = typeof navigator !== 'undefined' && 'serviceWorker' in navigator\r\n\r\nfunction waitForServiceWorker () {\r\n  return new Promise((resolve, reject) => {\r\n    if (!isSupported) {\r\n      reject(new Error('Unsupported'))\r\n    } else if (navigator.serviceWorker.controller) {\r\n      // A serviceWorker is already registered and active.\r\n      resolve()\r\n    } else {\r\n      navigator.serviceWorker.addEventListener('controllerchange', () => {\r\n        resolve()\r\n      })\r\n    }\r\n  })\r\n}\r\n\r\nclass ServiceWorkerStore {\r\n  constructor (opts) {\r\n    this.ready = waitForServiceWorker()\r\n    this.name = opts.storeName\r\n  }\r\n\r\n  list () {\r\n    const defer = {}\r\n    const promise = new Promise((resolve, reject) => {\r\n      defer.resolve = resolve\r\n      defer.reject = reject\r\n    })\r\n\r\n    console.log('Loading stored blobs from Service Worker')\r\n    const onMessage = (event) => {\r\n      if (event.data.store !== this.name) {\r\n        return\r\n      }\r\n      switch (event.data.type) {\r\n        case 'uppy/ALL_FILES':\r\n          defer.resolve(event.data.files)\r\n          navigator.serviceWorker.removeEventListener('message', onMessage)\r\n          break\r\n      }\r\n    }\r\n\r\n    this.ready.then(() => {\r\n      navigator.serviceWorker.addEventListener('message', onMessage)\r\n\r\n      navigator.serviceWorker.controller.postMessage({\r\n        type: 'uppy/GET_FILES',\r\n        store: this.name\r\n      })\r\n    })\r\n\r\n    return promise\r\n  }\r\n\r\n  put (file) {\r\n    return this.ready.then(() => {\r\n      navigator.serviceWorker.controller.postMessage({\r\n        type: 'uppy/ADD_FILE',\r\n        store: this.name,\r\n        file: file\r\n      })\r\n    })\r\n  }\r\n\r\n  delete (fileID) {\r\n    return this.ready.then(() => {\r\n      navigator.serviceWorker.controller.postMessage({\r\n        type: 'uppy/REMOVE_FILE',\r\n        store: this.name,\r\n        fileID: fileID\r\n      })\r\n    })\r\n  }\r\n}\r\n\r\nServiceWorkerStore.isSupported = isSupported\r\n\r\nmodule.exports = ServiceWorkerStore\r\n"]}