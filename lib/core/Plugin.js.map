{"version":3,"sources":["../../src/core/Plugin.js"],"names":["preact","require","findDOMElement","debounce","fn","calling","latestArgs","args","resolve","then","module","exports","uppy","opts","update","bind","mount","install","uninstall","getPluginState","getState","plugins","id","setPluginState","setState","state","el","_updateUI","target","plugin","callerPluginName","targetElement","isTargetDOMEl","rerender","getPlugin","render","log","replaceTargetContent","innerHTML","targetPlugin","Plugin","Target","iteratePlugins","targetPluginName","addTarget","Error","unmount","parentNode","removeChild"],"mappings":"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","file":"Plugin.js","sourcesContent":["const preact = require('preact')\r\nconst findDOMElement = require('../utils/findDOMElement')\r\n\r\n/**\r\n * Defer a frequent call to the microtask queue.\r\n */\r\nfunction debounce (fn) {\r\n  let calling = null\r\n  let latestArgs = null\r\n  return (...args) => {\r\n    latestArgs = args\r\n    if (!calling) {\r\n      calling = Promise.resolve().then(() => {\r\n        calling = null\r\n        // At this point `args` may be different from the most\r\n        // recent state, if multiple calls happened since this task\r\n        // was queued. So we use the `latestArgs`, which definitely\r\n        // is the most recent call.\r\n        return fn(...latestArgs)\r\n      })\r\n    }\r\n    return calling\r\n  }\r\n}\r\n\r\n/**\r\n * Boilerplate that all Plugins share - and should not be used\r\n * directly. It also shows which methods final plugins should implement/override,\r\n * this deciding on structure.\r\n *\r\n * @param {object} main Uppy core object\r\n * @param {object} object with plugin options\r\n * @return {array | string} files or success/fail message\r\n */\r\nmodule.exports = class Plugin {\r\n  constructor (uppy, opts) {\r\n    this.uppy = uppy\r\n    this.opts = opts || {}\r\n\r\n    this.update = this.update.bind(this)\r\n    this.mount = this.mount.bind(this)\r\n    this.install = this.install.bind(this)\r\n    this.uninstall = this.uninstall.bind(this)\r\n  }\r\n\r\n  getPluginState () {\r\n    const { plugins } = this.uppy.getState()\r\n    return plugins[this.id]\r\n  }\r\n\r\n  setPluginState (update) {\r\n    const plugins = Object.assign({}, this.uppy.getState().plugins)\r\n    plugins[this.id] = Object.assign({}, plugins[this.id], update)\r\n\r\n    this.uppy.setState({\r\n      plugins: plugins\r\n    })\r\n  }\r\n\r\n  update (state) {\r\n    if (typeof this.el === 'undefined') {\r\n      return\r\n    }\r\n\r\n    if (this._updateUI) {\r\n      this._updateUI(state)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if supplied `target` is a DOM element or an `object`.\r\n   * If it’s an object — target is a plugin, and we search `plugins`\r\n   * for a plugin with same name and return its target.\r\n   *\r\n   * @param {String|Object} target\r\n   *\r\n   */\r\n  mount (target, plugin) {\r\n    const callerPluginName = plugin.id\r\n\r\n    const targetElement = findDOMElement(target)\r\n\r\n    if (targetElement) {\r\n      this.isTargetDOMEl = true\r\n\r\n      // API for plugins that require a synchronous rerender.\r\n      this.rerender = (state) => {\r\n        // plugin could be removed, but this.rerender is debounced below,\r\n        // so it could still be called even after uppy.removePlugin or uppy.close\r\n        // hence the check\r\n        if (!this.uppy.getPlugin(this.id)) return\r\n        this.el = preact.render(this.render(state), targetElement, this.el)\r\n      }\r\n      this._updateUI = debounce(this.rerender)\r\n\r\n      this.uppy.log(`Installing ${callerPluginName} to a DOM element`)\r\n\r\n      // clear everything inside the target container\r\n      if (this.opts.replaceTargetContent) {\r\n        targetElement.innerHTML = ''\r\n      }\r\n\r\n      this.el = preact.render(this.render(this.uppy.getState()), targetElement)\r\n\r\n      return this.el\r\n    }\r\n\r\n    let targetPlugin\r\n    if (typeof target === 'object' && target instanceof Plugin) {\r\n      // Targeting a plugin *instance*\r\n      targetPlugin = target\r\n    } else if (typeof target === 'function') {\r\n      // Targeting a plugin type\r\n      const Target = target\r\n      // Find the target plugin instance.\r\n      this.uppy.iteratePlugins((plugin) => {\r\n        if (plugin instanceof Target) {\r\n          targetPlugin = plugin\r\n          return false\r\n        }\r\n      })\r\n    }\r\n\r\n    if (targetPlugin) {\r\n      const targetPluginName = targetPlugin.id\r\n      this.uppy.log(`Installing ${callerPluginName} to ${targetPluginName}`)\r\n      this.el = targetPlugin.addTarget(plugin)\r\n      return this.el\r\n    }\r\n\r\n    this.uppy.log(`Not installing ${callerPluginName}`)\r\n    throw new Error(`Invalid target option given to ${callerPluginName}`)\r\n  }\r\n\r\n  render (state) {\r\n    throw (new Error('Extend the render method to add your plugin to a DOM element'))\r\n  }\r\n\r\n  addTarget (plugin) {\r\n    throw (new Error('Extend the addTarget method to add your plugin to another plugin\\'s target'))\r\n  }\r\n\r\n  unmount () {\r\n    if (this.isTargetDOMEl && this.el && this.el.parentNode) {\r\n      this.el.parentNode.removeChild(this.el)\r\n    }\r\n  }\r\n\r\n  install () {\r\n\r\n  }\r\n\r\n  uninstall () {\r\n    this.unmount()\r\n  }\r\n}\r\n"]}